# This script is used to compare the database deployment script with default one to make sure that releases with actual change will require manual intervention
# This script is based https://confluence.teamabc.com/display/PRAC/How+To%3A+Setup+an+Octopus+project+to+automate+SQL+Deployment+Approval+Step manual

$NoChangesReport = '<?xml version="1.0" encoding="utf-8"?><DeploymentReport xmlns="http://schemas.microsoft.com/sqlserver/dac/DeployReport/2012/02"><Alerts /></DeploymentReport>'

TRY
{
    # (re)setting  the ApprovalRequired variable to null as Octopus stores and reuse the value during redeployment.
    Set-OctopusVariable -name "ApprovalRequired" -value $null

	$ArtifactDownloadFilePath = $OctopusParameters["ArtifactDownloadFilePath"]
	$OctopusEnvironmentName = $OctopusParameters["Octopus.Environment.Name"]
	$DatabaseName = $OctopusParameters["DatabaseName"]
	$OctopusReleaseNumber = $OctopusParameters["Octopus.Release.Number"]
    $TargetServers = $OctopusParameters["TargetServers"]
    
    $deployReportContent = Get-Content "$ArtifactDownloadFilePath\deployreports\$TargetServers.$OctopusEnvironmentName.$DatabaseName.$OctopusReleaseNumber.deployreport.xml"

    IF ( $NoChangesReport -eq $deployReportContent) {
        write-output "Deploy report matches at least one of the auto approved XMLs. DB deploy approval step can be skipped."
        Set-OctopusVariable -name "ApprovalRequired" -value "False"
    } else {
        write-output "Deploy Report does not match any of the auto approved XMLs. DB deploy approval required."
        Set-OctopusVariable -name "ApprovalRequired" -value "True"
    }
}
CATCH
{
    $ErrorMessage = $_.Exception.Message
    WRITE-WARNING "ERROR in processing the artifact(s) : $ErrorMessage "
    Set-OctopusVariable -name "ApprovalRequired" -value "True"
}


Action - DeployReport, Script, Publish
DacpacFilePath - "C:\abc\releases\databases\EmployeeInvitation\Employee.Invitation.Database.Build.dacpac"
ArtifactDownloadFilePath - "C:\abc\releases\databases\EmployeeInvitation"
DatabaseName - EmployeeInvitation
PublishProfileFilePath - "C:\abc\releases\databases\EmployeeInvitation\abc-uat.publish.xml"
PublishProfileFileName - abc-uat.publish.xml
TargetServers -  employeeinvitation.db.livestage6.test.abc.com
DeployReportFilePath - "C:\abc\releases\databases\EmployeeInvitation\deployreports\LS6 Global - 01.EmployeeInvitation.#{Octopus.Release.Number}.deployreport.xml"
SqlPackagePath - C:\Program Files\Microsoft SQL Server\150\DAC\bin\SqlPackage.exe
SQLPackageDeployProperties - {"AdditionalDeploymentContributorArguments":"CreateIndexOperationalPropsModifier.Online=ON;CreateIndexOperationalPropsModifier.MAXDOP=2"}
AddArtifactsToRelease - $AddArtifactsToRelease  -eq "true"
UsingClusterNames - $UsingClusterNames -eq "true"
UseServiceAccount -$UseServiceAccount -eq "true"
UseMultiSubnetFailover - $UseMultiSubnetFailover -eq "true"


ServiceAccountUserName - These are not getting used we need to pass the actual username and password.
ServiceAccountPassword - These are not getting used we need to pass the actual username and password.
SqlCmdVariables - Didnt get any reference but it is present as function in (lib/CloudDataSQLPackageDeploy/script.ps1)
SqlPackageParameters - Didnt get any reference but it is present as function in (lib/CloudDataSQLPackageDeploy/script.ps1) 


OctopusEnvironmentName - LS6 Global - 01
OctopusReleaseNumber - 
